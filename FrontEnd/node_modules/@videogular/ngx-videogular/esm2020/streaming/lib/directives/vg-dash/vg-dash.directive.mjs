import { Directive, Input, Output, EventEmitter, ElementRef, } from '@angular/core';
import { VgApiService, } from '@videogular/ngx-videogular/core';
import * as i0 from "@angular/core";
import * as i1 from "@videogular/ngx-videogular/core";
export class VgDashDirective {
    constructor(ref, API) {
        this.ref = ref;
        this.API = API;
        this.onGetBitrates = new EventEmitter();
        this.subscriptions = [];
    }
    ngOnInit() {
        if (this.API.isPlayerReady) {
            this.onPlayerReady();
        }
        else {
            this.subscriptions.push(this.API.playerReadyEvent.subscribe(() => this.onPlayerReady()));
        }
    }
    onPlayerReady() {
        this.vgFor = this.ref.nativeElement.getAttribute('vgFor');
        this.target = this.API.getMediaById(this.vgFor);
        this.createPlayer();
    }
    ngOnChanges(changes) {
        changes.vgDash?.currentValue ? this.createPlayer() : this.destroyPlayer();
    }
    createPlayer() {
        if (this.dash) {
            this.destroyPlayer();
        }
        // It's a DASH source
        if (this.vgDash &&
            (this.vgDash.indexOf('.mpd') > -1 ||
                this.vgDash.indexOf('mpd-time-csf') > -1)) {
            let drmOptions;
            if (this.vgDRMLicenseServer) {
                drmOptions = this.vgDRMLicenseServer;
                if (this.vgDRMToken) {
                    for (const drmServer in drmOptions) {
                        if (drmServer.hasOwnProperty(drmServer)) {
                            drmOptions[drmServer].httpRequestHeaders = {
                                Authorization: this.vgDRMToken,
                            };
                        }
                    }
                }
            }
            this.dash = dashjs.MediaPlayer().create();
            this.dash.updateSettings({ debug: { logLevel: dashjs.Debug.LOG_LEVEL_NONE } });
            this.dash.initialize(this.ref.nativeElement);
            this.dash.setAutoPlay(false);
            this.dash.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                const audioList = this.dash.getBitrateInfoListFor('audio');
                const videoList = this.dash.getBitrateInfoListFor('video');
                if (audioList.length > 1) {
                    audioList.forEach((item) => (item.qualityIndex = ++item.qualityIndex));
                    audioList.unshift({
                        qualityIndex: 0,
                        width: 0,
                        height: 0,
                        bitrate: 0,
                        mediaType: 'video',
                        scanType: 'AUTO',
                    });
                    this.onGetBitrates.emit(audioList);
                }
                if (videoList.length > 1) {
                    videoList.forEach((item) => (item.qualityIndex = ++item.qualityIndex));
                    videoList.unshift({
                        qualityIndex: 0,
                        width: 0,
                        height: 0,
                        bitrate: 0,
                        mediaType: 'video',
                        scanType: 'AUTO',
                    });
                    this.onGetBitrates.emit(videoList);
                }
            });
            if (drmOptions) {
                this.dash.setProtectionData(drmOptions);
            }
            this.dash.attachSource(this.vgDash);
        }
        else {
            if (this.target) {
                this.target.pause();
                this.target.seekTime(0);
                this.ref.nativeElement.src = this.vgDash;
            }
        }
    }
    setBitrate({ mediaType, qualityIndex }) {
        if (this.dash) {
            if (qualityIndex > 0) {
                if (this.dash.getSettings()) {
                    this.dash.updateSettings({
                        streaming: {
                            abr: {
                                autoSwitchBitrate: {
                                    [mediaType]: false
                                }
                            }
                        }
                    });
                }
                const nextIndex = qualityIndex - 1;
                this.dash.setQualityFor(mediaType, nextIndex);
            }
            else {
                this.dash.updateSettings({
                    streaming: {
                        abr: {
                            autoSwitchBitrate: {
                                [mediaType]: true
                            }
                        }
                    }
                });
            }
        }
    }
    destroyPlayer() {
        if (this.dash) {
            this.dash.reset();
            this.dash = null;
        }
    }
    ngOnDestroy() {
        this.subscriptions.forEach((s) => s.unsubscribe());
        this.destroyPlayer();
    }
}
/** @nocollapse */ VgDashDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: VgDashDirective, deps: [{ token: i0.ElementRef }, { token: i1.VgApiService }], target: i0.ɵɵFactoryTarget.Directive });
/** @nocollapse */ VgDashDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "14.0.6", type: VgDashDirective, selector: "[vgDash]", inputs: { vgDash: "vgDash", vgDRMToken: "vgDRMToken", vgDRMLicenseServer: "vgDRMLicenseServer" }, outputs: { onGetBitrates: "onGetBitrates" }, exportAs: ["vgDash"], usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.0.6", ngImport: i0, type: VgDashDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[vgDash]',
                    exportAs: 'vgDash',
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.VgApiService }]; }, propDecorators: { vgDash: [{
                type: Input
            }], vgDRMToken: [{
                type: Input
            }], vgDRMLicenseServer: [{
                type: Input
            }], onGetBitrates: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmctZGFzaC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL25neC12aWRlb2d1bGFyL3N0cmVhbWluZy9zcmMvbGliL2RpcmVjdGl2ZXMvdmctZGFzaC92Zy1kYXNoLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUlULEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLFVBQVUsR0FFWCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBR0wsWUFBWSxHQUNiLE1BQU0saUNBQWlDLENBQUM7OztBQWN6QyxNQUFNLE9BQU8sZUFBZTtJQWExQixZQUFvQixHQUFlLEVBQVMsR0FBaUI7UUFBekMsUUFBRyxHQUFILEdBQUcsQ0FBWTtRQUFTLFFBQUcsR0FBSCxHQUFHLENBQWM7UUFSbkQsa0JBQWEsR0FBbUMsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU03RSxrQkFBYSxHQUFtQixFQUFFLENBQUM7SUFFNkIsQ0FBQztJQUVqRSxRQUFRO1FBQ04sSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRTtZQUMxQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDdEI7YUFBTTtZQUNMLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUNyQixJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FDaEUsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUVELGFBQWE7UUFDWCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENB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QUFLO2lDQUNuQjs2QkFDRjt5QkFDRjtxQkFDRixDQUFDLENBQUM7aUJBQ0o7Z0JBRUQsTUFBTSxTQUFTLEdBQUcsWUFBWSxHQUFHLENBQUMsQ0FBQztnQkFDbkMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQy9DO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDO29CQUN2QixTQUFTLEVBQUU7d0JBQ1QsR0FBRyxFQUFFOzRCQUNILGlCQUFpQixFQUFFO2dDQUNqQixDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUk7NkJBQ2xCO3lCQUNGO3FCQUNGO2lCQUNGLENBQUMsQ0FBQzthQUNKO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsYUFBYTtRQUNYLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtZQUNiLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7U0FDbEI7SUFDSCxDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQzs7K0hBbEtVLGVBQWU7bUhBQWYsZUFBZTsyRkFBZixlQUFlO2tCQUozQixTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxVQUFVO29CQUNwQixRQUFRLEVBQUUsUUFBUTtpQkFDbkI7NEhBRVUsTUFBTTtzQkFBZCxLQUFLO2dCQUNHLFVBQVU7c0JBQWxCLEtBQUs7Z0JBQ0csa0JBQWtCO3NCQUExQixLQUFLO2dCQUVJLGFBQWE7c0JBQXRCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIE9uSW5pdCxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgRWxlbWVudFJlZixcbiAgU2ltcGxlQ2hhbmdlcyxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIElEUk1MaWNlbnNlU2VydmVyLFxuICBCaXRyYXRlT3B0aW9ucyxcbiAgVmdBcGlTZXJ2aWNlLFxufSBmcm9tICdAdmlkZW9ndWxhci9uZ3gtdmlkZW9ndWxhci9jb3JlJztcblxuZGVjbGFyZSBsZXQgZGFzaGpzOiB7XG4gIE1lZGlhUGxheWVyOiB7XG4gICAgKCk6IHsgKCk6IGFueTsgbmV3ICgpOiBhbnk7IGNyZWF0ZTogeyAoKTogYW55OyBuZXcgKCk6IGFueSB9IH07XG4gICAgZXZlbnRzOiB7IFNUUkVBTV9JTklUSUFMSVpFRDogYW55IH07XG4gIH07XG4gIERlYnVnOiB7IExPR19MRVZFTF9OT05FOiBhbnkgfTtcbn07XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1t2Z0Rhc2hdJyxcbiAgZXhwb3J0QXM6ICd2Z0Rhc2gnLFxufSlcbmV4cG9ydCBjbGFzcyBWZ0Rhc2hEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgQElucHV0KCkgdmdEYXNoOiBzdHJpbmc7XG4gIEBJbnB1dCgpIHZnRFJNVG9rZW46IHN0cmluZztcbiAgQElucHV0KCkgdmdEUk1MaWNlbnNlU2VydmVyOiBJRFJNTGljZW5zZVNlcnZlcjtcblxuICBAT3V0cHV0KCkgb25HZXRCaXRyYXRlczogRXZlbnRFbWl0dGVyPEJpdHJhdGVPcHRpb25zW10+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHZnRm9yOiBzdHJpbmc7XG4gIHRhcmdldDogYW55O1xuICBkYXNoOiBhbnk7XG5cbiAgc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uW10gPSBbXTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlZjogRWxlbWVudFJlZiwgcHVibGljIEFQSTogVmdBcGlTZXJ2aWNlKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICh0aGlzLkFQSS5pc1BsYXllclJlYWR5KSB7XG4gICAgICB0aGlzLm9uUGxheWVyUmVhZHkoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2goXG4gICAgICAgIHRoaXMuQVBJLnBsYXllclJlYWR5RXZlbnQuc3Vic2NyaWJlKCgpID0+IHRoaXMub25QbGF5ZXJSZWFkeSgpKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBvblBsYXllclJlYWR5KCkge1xuICAgIHRoaXMudmdGb3IgPSB0aGlzLnJlZi5uYXRpdmVFbGVtZW50LmdldEF0dHJpYnV0ZSgndmdGb3InKTtcbiAgICB0aGlzLnRhcmdldCA9IHRoaXMuQVBJLmdldE1lZGlhQnlJZCh0aGlzLnZnRm9yKTtcbiAgICB0aGlzLmNyZWF0ZVBsYXllcigpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGNoYW5nZXMudmdEYXNoPy5jdXJyZW50VmFsdWUgPyB0aGlzLmNyZWF0ZVBsYXllcigpIDogdGhpcy5kZXN0cm95UGxheWVyKCk7XG4gIH1cblxuICBjcmVhdGVQbGF5ZXIoKSB7XG4gICAgaWYgKHRoaXMuZGFzaCkge1xuICAgICAgdGhpcy5kZXN0cm95UGxheWVyKCk7XG4gICAgfVxuXG4gICAgLy8gSXQncyBhIERBU0ggc291cmNlXG4gICAgaWYgKFxuICAgICAgdGhpcy52Z0Rhc2ggJiZcbiAgICAgICh0aGlzLnZnRGFzaC5pbmRleE9mKCcubXBkJykgPiAtMSB8fFxuICAgICAgICB0aGlzLnZnRGFzaC5pbmRleE9mKCdtcGQtdGltZS1jc2YnKSA+IC0xKVxuICAgICkge1xuICAgICAgbGV0IGRybU9wdGlvbnM6IGFueTtcblxuICAgICAgaWYgKHRoaXMudmdEUk1MaWNlbnNlU2VydmVyKSB7XG4gICAgICAgIGRybU9wdGlvbnMgPSB0aGlzLnZnRFJNTGljZW5zZVNlcnZlcjtcblxuICAgICAgICBpZiAodGhpcy52Z0RSTVRva2VuKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBkcm1TZXJ2ZXIgaW4gZHJtT3B0aW9ucykge1xuICAgICAgICAgICAgaWYgKGRybVNlcnZlci5oYXNPd25Qcm9wZXJ0eShkcm1TZXJ2ZXIpKSB7XG4gICAgICAgICAgICAgIGRybU9wdGlvbnNbZHJtU2VydmVyXS5odHRwUmVxdWVzdEhlYWRlcnMgPSB7XG4gICAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogdGhpcy52Z0RSTVRva2VuLFxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGlzLmRhc2ggPSBkYXNoanMuTWVkaWFQbGF5ZXIoKS5jcmVhdGUoKTtcbiAgICAgIHRoaXMuZGFzaC51cGRhdGVTZXR0aW5ncyh7ZGVidWc6IHtsb2dMZXZlbDogZGFzaGpzLkRlYnVnLkxPR19MRVZFTF9OT05FfX0pO1xuICAgICAgdGhpcy5kYXNoLmluaXRpYWxpemUodGhpcy5yZWYubmF0aXZlRWxlbWVudCk7XG4gICAgICB0aGlzLmRhc2guc2V0QXV0b1BsYXkoZmFsc2UpO1xuXG4gICAgICB0aGlzLmRhc2gub24oZGFzaGpzLk1lZGlhUGxheWVyLmV2ZW50cy5TVFJFQU1fSU5JVElBTElaRUQsICgpID0+IHtcbiAgICAgICAgY29uc3QgYXVkaW9MaXN0ID0gdGhpcy5kYXNoLmdldEJpdHJhdGVJbmZvTGlzdEZvcignYXVkaW8nKTtcbiAgICAgICAgY29uc3QgdmlkZW9MaXN0ID0gdGhpcy5kYXNoLmdldEJpdHJhdGVJbmZvTGlzdEZvcigndmlkZW8nKTtcblxuICAgICAgICBpZiAoYXVkaW9MaXN0Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICBhdWRpb0xpc3QuZm9yRWFjaChcbiAgICAgICAgICAgIChpdGVtOiB7IHF1YWxpdHlJbmRleDogbnVtYmVyIH0pID0+XG4gICAgICAgICAgICAgIChpdGVtLnF1YWxpdHlJbmRleCA9ICsraXRlbS5xdWFsaXR5SW5kZXgpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBhdWRpb0xpc3QudW5zaGlmdCh7XG4gICAgICAgICAgICBxdWFsaXR5SW5kZXg6IDAsXG4gICAgICAgICAgICB3aWR0aDogMCxcbiAgICAgICAgICAgIGhlaWdodDogMCxcbiAgICAgICAgICAgIGJpdHJhdGU6IDAsXG4gICAgICAgICAgICBtZWRpYVR5cGU6ICd2aWRlbycsXG4gICAgICAgICAgICBzY2FuVHlwZTogJ0FVVE8nLFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgdGhpcy5vbkdldEJpdHJhdGVzLmVtaXQoYXVkaW9MaXN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2aWRlb0xpc3QubGVuZ3RoID4gMSkge1xuICAgICAgICAgIHZpZGVvTGlzdC5mb3JFYWNoKFxuICAgICAgICAgICAgKGl0ZW06IHtxdWFsaXR5SW5kZXg6IG51bWJlcn0pID0+IChcbiAgICAgICAgICAgICAgaXRlbS5xdWFsaXR5SW5kZXggPSArK2l0ZW0ucXVhbGl0eUluZGV4XG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgICB2aWRlb0xpc3QudW5zaGlmdCh7XG4gICAgICAgICAgICBxdWFsaXR5SW5kZXg6IDAsXG4gICAgICAgICAgICB3aWR0aDogMCxcbiAgICAgICAgICAgIGhlaWdodDogMCxcbiAgICAgICAgICAgIGJpdHJhdGU6IDAsXG4gICAgICAgICAgICBtZWRpYVR5cGU6ICd2aWRlbycsXG4gICAgICAgICAgICBzY2FuVHlwZTogJ0FVVE8nLFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgdGhpcy5vbkdldEJpdHJhdGVzLmVtaXQodmlkZW9MaXN0KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGlmIChkcm1PcHRpb25zKSB7XG4gICAgICAgIHRoaXMuZGFzaC5zZXRQcm90ZWN0aW9uRGF0YShkcm1PcHRpb25zKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5kYXNoLmF0dGFjaFNvdXJjZSh0aGlzLnZnRGFzaCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLnRhcmdldCkge1xuICAgICAgICB0aGlzLnRhcmdldC5wYXVzZSgpO1xuICAgICAgICB0aGlzLnRhcmdldC5zZWVrVGltZSgwKTtcbiAgICAgICAgdGhpcy5yZWYubmF0aXZlRWxlbWVudC5zcmMgPSB0aGlzLnZnRGFzaDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZXRCaXRyYXRlKHttZWRpYVR5cGUsIHF1YWxpdHlJbmRleH06IEJpdHJhdGVPcHRpb25zKSB7XG4gICAgaWYgKHRoaXMuZGFzaCkge1xuICAgICAgaWYgKHF1YWxpdHlJbmRleCA+IDApIHtcbiAgICAgICAgaWYgKHRoaXMuZGFzaC5nZXRTZXR0aW5ncygpKSB7XG4gICAgICAgICAgdGhpcy5kYXNoLnVwZGF0ZVNldHRpbmdzKHtcbiAgICAgICAgICAgIHN0cmVhbWluZzoge1xuICAgICAgICAgICAgICBhYnI6IHtcbiAgICAgICAgICAgICAgICBhdXRvU3dpdGNoQml0cmF0ZToge1xuICAgICAgICAgICAgICAgICAgW21lZGlhVHlwZV06IGZhbHNlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBuZXh0SW5kZXggPSBxdWFsaXR5SW5kZXggLSAxO1xuICAgICAgICB0aGlzLmRhc2guc2V0UXVhbGl0eUZvcihtZWRpYVR5cGUsIG5leHRJbmRleCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmRhc2gudXBkYXRlU2V0dGluZ3Moe1xuICAgICAgICAgIHN0cmVhbWluZzoge1xuICAgICAgICAgICAgYWJyOiB7XG4gICAgICAgICAgICAgIGF1dG9Td2l0Y2hCaXRyYXRlOiB7XG4gICAgICAgICAgICAgICAgW21lZGlhVHlwZV06IHRydWVcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZGVzdHJveVBsYXllcigpIHtcbiAgICBpZiAodGhpcy5kYXNoKSB7XG4gICAgICB0aGlzLmRhc2gucmVzZXQoKTtcbiAgICAgIHRoaXMuZGFzaCA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmZvckVhY2goKHMpID0+IHMudW5zdWJzY3JpYmUoKSk7XG4gICAgdGhpcy5kZXN0cm95UGxheWVyKCk7XG4gIH1cbn1cbiJdfQ==